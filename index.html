<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>POS ‚Äì La Bomba 44</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* ===== Paleta de marca (inspirada en el logo) ===== */
    :root{
      --brand-900:#7f1519;
      --brand-800:#8e181d;
      --brand-700:#9d1b20;
      --brand-600:#ab1e22;
      --brand-500:#b62025;
      --brand-200:#fde8ea;
      --brand-100:#fff1f2;
      --brand-50:#fff7f7;

      --ink:#2b2b2b;
      --muted:#6b7280;
      --card:#fff9f8;
      --card-border:#f1d4d7;
      --success:#d1fae5;
      --success-border:#a7f3d0;
      --warn-bg:#fff4e6;
      --warn-border:#ffd8b5;
    }
    .bg-brand-700{ background:var(--brand-700); }
    .bg-brand-100{ background:var(--brand-100); }
    .bg-brand-50{  background:var(--brand-50); }
    .text-brand-200{ color:var(--brand-200); }
    .tab-active{ background:var(--brand-700)!important; color:#fff!important; border-color:transparent!important; }

    /* ===== Header ===== */
    .header-wrap{
      background:linear-gradient(180deg, var(--brand-700) 0%, var(--brand-600) 100%);
      color:#fff;
    }

    /* ===== Productos: hover notorio + feedback de selecci√≥n ===== */
    @keyframes addedPulse {
      10% { box-shadow:0 0 0 0 rgba(20,200,170,.30); }
      100% { box-shadow:0 0 0 12px rgba(16,185,129,5); }
    }
    .producto-item{
      background:var(--card);
      border:4px solid var(--card-border);
      border-radius:12px;
      padding:12px;
      box-shadow:0 2px 6px rgba(0,0,0,.10);
      transition:background-color .2s, transform .12s ease, box-shadow .2s, border-color .2s;
      will-change: transform;
    }
    .producto-item:hover{
  background:#fcd6d8; /* un poco m√°s oscuro que #ffeceb */
  transform:translateY(-4px) scale(1.02);
  box-shadow:0 10px 20px rgba(0,0,0,.30); /* leve m√°s fuerte */
  border-color:#e4aeb3; /* borde m√°s notorio */
}

    .producto-item:active{
      transform:translateY(-1px) scale(0.99);
      box-shadow:0 6px 12px rgba(0,0,0,.10);
    }
    /* Estado seleccionado (en carrito) */
    .producto-seleccionado{
      background:var(--success)!important;
      border-color:var(--success-border)!important;
      box-shadow: inset 0 0 0 2px rgba(5,150,105,.25);
    }
    /* Pulso breve cuando se agrega */
    .added-pulse{ animation: addedPulse .45s ease-out; }
    /* Visual sin stock (no bloquea) */
    .btn-sin-stock{ opacity:.6 }
    /* Badge de stock y aviso bajo */
    .badge-stock{
      display:inline-block;font-size:11px;padding:2px 8px;border-radius:9999px;
      background:#eef2ff;border:1px solid #c7d2fe;color:#312e81
    }
    .stock-bajo{ background:var(--warn-bg); border-color:var(--warn-border); color:#9a5a14 }

    body{ color:var(--ink); background:var(--brand-50); }
  </style>
</head>
<body>
  <!-- ===== Header con t√≠tulo centrado y logo a la izquierda ===== -->
  <header class="header-wrap px-4 py-3">
    <div class="max-w-6xl mx-auto grid grid-cols-3 items-center gap-3">
      <!-- IZQUIERDA: Logo -->
      <div class="flex items-center">
        <img src="logo.jpeg" alt="La Bomba 44" style="height:56px;width:auto;object-fit:contain;border-radius:6px;background:transparent" />
      </div>
      <!-- CENTRO: T√≠tulo -->
      <div class="text-center">
        <h1 class="text-2xl font-extrabold tracking-wide">La Bomba 44 ¬∑ POS</h1>
        <p class="text-brand-200 text-sm">Venta ¬∑ Ventas del d√≠a ¬∑ Productos ¬∑ Inventario ¬∑ Cierre</p>
      </div>
      <!-- DERECHA: Espaciador para equilibrar el centrado -->
      <div></div>
    </div>
  </header>

  <main class="p-4 max-w-6xl mx-auto">
    <!-- ===== Tabs ===== -->
    <div class="flex flex-wrap gap-2 mb-4">
      <button id="tab-venta" class="tab-btn px-4 py-2 rounded border bg-brand-700 text-white">Venta</button>
      <button id="tab-ventas-dia" class="tab-btn px-4 py-2 rounded border bg-white">Ventas del d√≠a</button>
      <button id="tab-productos" class="tab-btn px-4 py-2 rounded border bg-white">Productos</button>
      <button id="tab-inventario" class="tab-btn px-4 py-2 rounded border bg-white">Inventario</button>
      <button id="tab-cierre" class="tab-btn px-4 py-2 rounded border bg-white">Cierre</button>
    </div>

    <!-- ===== VENTA ===== -->
    <section id="view-venta" class="space-y-4">
      <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
        <input id="search" type="text" placeholder="Buscar producto..." class="w-full p-2 border rounded col-span-2">
        <select id="filter-category" class="p-2 border rounded">
          <option value="">Todas las categor√≠as</option>
        </select>
      </div>

      <div id="product-list" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4"></div>

      <div class="mt-2 bg-white p-4 rounded shadow">
        <div class="flex items-center justify-between">
          <h2 class="text-xl font-bold">Carrito</h2>
          <button id="btn-clear" class="px-3 py-1 border rounded">Vaciar</button>
        </div>
        <ul id="cart" class="divide-y my-3"></ul>
        <div class="flex items-center justify-between">
          <div class="text-sm text-gray-500" id="cart-items-count">0 √≠tems</div>
          <div class="text-right">
            <div class="text-sm">Subtotal: <span id="subtotal" class="font-semibold">$0</span></div>
            <div class="text-sm">Descuento: <span id="discount-amount" class="font-semibold">$0</span></div>
            <div class="text-lg font-extrabold">Total: <span id="total">$0</span></div>
          </div>
        </div>
        <div class="mt-3 grid grid-cols-1 sm:grid-cols-3 gap-3">
          <input id="discount" type="number" min="0" max="100" class="p-2 border rounded" placeholder="Descuento % (opcional)">
          <select id="pay-method" class="p-2 border rounded">
            <option value="Efectivo">Efectivo</option>
            <option value="Transferencia">Transferencia</option>
            <option value="QR">QR</option>
          </select>
          <input id="cash-received" type="number" min="0" class="p-2 border rounded" placeholder="Recibido (efectivo)">
        </div>
        <div class="mt-2 text-right text-sm">Cambio: <span id="change" class="font-semibold">$0</span></div>
        <button id="checkout" class="px-4 py-2 rounded mt-4 w-full sm:w-auto" style="background:var(--brand-700);color:#fff">Finalizar venta</button>
      </div>
    </section>

    <!-- ===== VENTAS DEL D√çA ===== -->
    <section id="view-ventas-dia" class="hidden">
      <div class="bg-white p-4 rounded shadow">
        <div class="flex items-center justify-between">
          <h2 class="text-xl font-bold">Ventas del d√≠a</h2>
          <button id="btn-export" class="px-3 py-1 border rounded">Exportar CSV</button>
        </div>
        <div class="overflow-auto mt-3">
          <table class="w-full text-sm">
            <thead class="bg-brand-100">
              <tr><th class="p-2 text-left">#</th><th class="p-2">Hora</th><th class="p-2">M√©todo</th><th class="p-2 text-right">Total</th></tr>
            </thead>
            <tbody id="sales-body" class="divide-y"></tbody>
            <tfoot class="bg-brand-50">
              <tr><td colspan="3" class="p-2 text-right font-bold">TOTAL</td><td id="sum-total" class="p-2 text-right font-extrabold">$0</td></tr>
            </tfoot>
          </table>
        </div>
      </div>
    </section>

    <!-- ===== PRODUCTOS (CRUD) ===== -->
    <section id="view-productos" class="hidden space-y-4">
      <div class="bg-white p-4 rounded shadow">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
          <h2 class="text-xl font-bold">Productos</h2>
          <div class="flex flex-wrap gap-2">
            <button id="btn-add-product" class="px-3 py-2 rounded text-white" style="background:var(--brand-700)">Nuevo producto</button>
            <button id="btn-export-products" class="px-3 py-2 border rounded">Exportar CSV</button>
            <label class="px-3 py-2 border rounded cursor-pointer">
              Importar CSV
              <input id="input-import-products" type="file" accept=".csv" class="hidden">
            </label>
            <button id="btn-reset-defaults" class="px-3 py-2 border rounded text-red-600">Restaurar default</button>
          </div>
        </div>
        <div class="mt-3 overflow-auto">
          <table class="w-full text-sm">
            <thead class="bg-brand-100">
              <tr>
                <th class="p-2 text-left">Nombre</th>
                <th class="p-2 text-right">Precio</th>
                <th class="p-2 text-left">Categor√≠a</th>
                <th class="p-2 text-right">Acciones</th>
              </tr>
            </thead>
            <tbody id="product-body" class="divide-y"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- ===== INVENTARIO ===== -->
    <section id="view-inventario" class="hidden space-y-4">
      <div class="bg-white p-4 rounded shadow">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
          <h2 class="text-xl font-bold">Inventario</h2>
          <div class="flex flex-wrap gap-2">
            <button id="btn-inv-sync" class="px-3 py-2 border rounded">Sincronizar con productos</button>
            <button id="btn-inv-export" class="px-3 py-2 border rounded">Exportar CSV</button>
            <label class="px-3 py-2 border rounded cursor-pointer">
              Importar CSV
              <input id="input-inv-import" type="file" accept=".csv" class="hidden">
            </label>
            <button id="btn-inv-reset-min" class="px-3 py-2 border rounded">Min = 0</button>
          </div>
        </div>

        <div class="overflow-auto mt-3">
          <table class="w-full text-sm">
            <thead class="bg-brand-100">
              <tr>
                <th class="p-2 text-left">Producto</th>
                <th class="p-2 text-left">Categor√≠a</th>
                <th class="p-2 text-right">Stock</th>
                <th class="p-2 text-right">M√≠nimo</th>
                <th class="p-2 text-right">Acciones</th>
              </tr>
            </thead>
            <tbody id="inv-body" class="divide-y"></tbody>
          </table>
        </div>
        <p class="text-xs text-gray-500 mt-2">
          Se permite vender aunque el stock sea 0. Si hay stock disponible, se descuenta autom√°ticamente al finalizar la venta.
        </p>
      </div>
    </section>

    <!-- ===== CIERRE ===== -->
    <section id="view-cierre" class="hidden space-y-4">
      <div class="bg-white p-4 rounded shadow">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
          <h2 class="text-xl font-bold">Cierre de caja</h2>
          <div class="flex flex-wrap gap-2">
            <button id="btn-corte-x" class="px-3 py-2 border rounded">Corte X (imprimir)</button>
            <button id="btn-corte-z" class="px-3 py-2 text-white rounded" style="background:var(--brand-700)">Corte Z (cerrar d√≠a)</button>
          </div>
        </div>

        <div class="mt-3 overflow-auto">
          <table class="w-full text-sm">
            <thead class="bg-brand-100">
              <tr>
                <th class="p-2 text-left">M√©todo</th>
                <th class="p-2 text-right"># Tickets</th>
                <th class="p-2 text-right">Total</th>
                <th class="p-2 text-right">Promedio</th>
              </tr>
            </thead>
            <tbody id="cierre-body" class="divide-y"></tbody>
            <tfoot class="bg-brand-50">
              <tr>
                <td class="p-2 text-right font-bold">TOTAL</td>
                <td id="cierre-sum-cant" class="p-2 text-right font-extrabold">0</td>
                <td id="cierre-sum-total" class="p-2 text-right font-extrabold">$0</td>
                <td class="p-2"></td>
              </tr>
            </tfoot>
          </table>
        </div>
        <p class="text-xs text-gray-500 mt-2">El Corte X imprime el resumen sin borrar. El Corte Z registra un cierre y borra las ventas de hoy.</p>
      </div>
    </section>
  </main>

  <!-- ===== Modal Producto ===== -->
  <div id="product-modal" class="fixed inset-0 bg-black/40 hidden items-center justify-center p-4">
    <div class="bg-white w-full max-w-md rounded-lg shadow-lg p-4">
      <div class="flex items-center justify-between">
        <h3 id="product-modal-title" class="text-lg font-bold">Producto</h3>
        <button id="product-close" class="text-gray-500">‚úï</button>
      </div>
      <div class="mt-3 grid gap-3">
        <input id="pm-name" class="p-2 border rounded" placeholder="Nombre">
        <input id="pm-price" type="number" min="0" class="p-2 border rounded" placeholder="Precio (COP)">
        <input id="pm-category" class="p-2 border rounded" placeholder="Categor√≠a">
      </div>
      <div class="mt-4 flex gap-2 justify-end">
        <button id="product-save" class="px-3 py-2 text-white rounded" style="background:var(--brand-700)">Guardar</button>
      </div>
    </div>
  </div>

  <script>
    /* ===== Productos base ===== */
    const DEFAULT_PRODUCTS = [
      { name: "Caf√© negro", price: 1500, category: "Bebidas" },
      { name: "Caf√© con leche", price: 2000, category: "Bebidas" },
      { name: "Empanada de carne", price: 1500, category: "Pasabocas" },
      { name: "Sopa del d√≠a + bandeja (almuerzo)", price: 13500, category: "Almuerzos" },
      { name: "Solo bandeja (almuerzo)",           price: 12500, category: "Almuerzos" },
      { name: "Sopa del d√≠a + bandeja (cena)",     price: 13500, category: "Cenas" },
      { name: "Solo bandeja (cena)",               price: 12500, category: "Cenas" },
      { name: "Gaseosa 400 ml",                    price: 3500,  category: "Bebidas" },
      { name: "Cerveza Coste√±a (verde/negra)",     price: 3000,  category: "Bebidas" },
      { name: "Cerveza Poker / √Åguila Light",      price: 3500,  category: "Bebidas" },
      { name: "Agua con gas",                      price: 3000,  category: "Bebidas" },
      { name: "Agua natural",                      price: 2500,  category: "Bebidas" },
      { name: "Jugos Hit",                         price: 3500,  category: "Bebidas" },
      { name: "Squash",                             price: 3500,  category: "Bebidas" },
      { name: "Vive 100",                          price: 3000,  category: "Bebidas" },
      { name: "Saviloe",                           price: 3500,  category: "Bebidas" },
      { name: "Jugo natural (en agua)",            price: 4500,  category: "Bebidas" },
      { name: "Jugo natural (en leche)",           price: 5000,  category: "Bebidas" }
    ];
    const loadProducts = () => { try { return JSON.parse(localStorage.getItem('products_data')||'[]'); } catch(e){ return []; } };
    const saveProducts = (arr) => localStorage.setItem('products_data', JSON.stringify(arr));
    const getProducts  = () => { const a=loadProducts(); return a.length?a:DEFAULT_PRODUCTS.slice(); };

    /* ===== Inventario ===== */
    const loadInv   = () => { try { return JSON.parse(localStorage.getItem('inventory_data')||'{}'); } catch(e){ return {}; } };
    const saveInv   = (o) => localStorage.setItem('inventory_data', JSON.stringify(o||{}));
    const loadInvMin= () => { try { return JSON.parse(localStorage.getItem('inventory_min')||'{}'); } catch(e){ return {}; } };
    const saveInvMin= (o) => localStorage.setItem('inventory_min', JSON.stringify(o||{}));

    function syncInventoryWithProducts() {
      const inv = loadInv(); const min = loadInvMin(); const names = new Set();
      getProducts().forEach(p => { names.add(p.name); if(!(p.name in inv)) inv[p.name]=0; if(!(p.name in min)) min[p.name]=0; });
      Object.keys(inv).forEach(n => { if(!names.has(n)) delete inv[n]; });
      Object.keys(min).forEach(n => { if(!names.has(n)) delete min[n]; });
      saveInv(inv); saveInvMin(min);
    }

    /* ===== Util ===== */
    const COP = new Intl.NumberFormat('es-CO',{style:'currency',currency:'COP',maximumFractionDigits:0});
    const fmt = v => COP.format(v||0);
    const todayKey = () => { const d=new Date(); const u=d.getTime()+d.getTimezoneOffset()*60000; const b=new Date(u-5*3600000); return b.toISOString().slice(0,10); };
    const loadHist = () => JSON.parse(localStorage.getItem('ventas_historial')||'[]');
    const saveHist = a => localStorage.setItem('ventas_historial', JSON.stringify(a));
    const nextConsec = () => { const n=parseInt(localStorage.getItem('consecutivo')||'1000',10); localStorage.setItem('consecutivo', String(n+1)); return n; };

    /* ===== Venta ===== */
    let cart = [];
    function hydrateCategories(){
      const cats = Array.from(new Set(getProducts().map(p=>p.category))).sort();
      const sel = document.getElementById('filter-category');
      sel.innerHTML = '<option value="">Todas las categor√≠as</option>';
      cats.forEach(c=>{ const o=document.createElement('option'); o.value=c; o.textContent=c; sel.appendChild(o); });
    }
    function updateProductSelectionUI(){
      const mark=new Set(cart.map(i=>i.name));
      document.querySelectorAll('#product-list [data-name]').forEach(el=>{
        if(mark.has(el.dataset.name)) el.classList.add('producto-seleccionado');
        else el.classList.remove('producto-seleccionado');
      });
    }
    /* Hover notorio + feedback al presionar (pulso) y selecci√≥n persistente */
    function renderProducts(filterText = '', cat = ''){
      const list=document.getElementById('product-list'); list.innerHTML='';
      const inv=loadInv(), mins=loadInvMin();
      getProducts()
        .filter(p=>p.name.toLowerCase().includes(filterText.toLowerCase()))
        .filter(p=>!cat || p.category===cat)
        .forEach(p=>{
          const stock=inv[p.name]||0, bajo=(stock <= (mins[p.name]||0));
          const btn=document.createElement('button');
          btn.className='producto-item text-center';
          btn.dataset.name=p.name;
          if(stock===0) btn.classList.add('btn-sin-stock');
          if(bajo && stock>0) btn.classList.add('stock-bajo');
          btn.innerHTML = `
            <h3 class="font-bold leading-tight">${p.name}</h3>
            <p class="font-extrabold" style="color:var(--brand-700)">${fmt(p.price)}</p>
            <div class="mt-1">
              <span class="badge-stock ${bajo ? 'stock-bajo' : ''}">Stock: ${stock}</span>
            </div>`;
          btn.onclick=(e)=>{
            addToCart(p);
            // Pulso breve de confirmaci√≥n de ‚Äúagregado‚Äù
            e.currentTarget.classList.add('added-pulse');
            setTimeout(()=>e.currentTarget.classList.remove('added-pulse'), 450);
          };
          list.appendChild(btn);
        });
      updateProductSelectionUI();
    }
    function addToCart(p){
      const f=cart.find(i=>i.name===p.name);
      if(f) f.qty++; else cart.push({...p,qty:1});
      renderCart();
    }
    function changeQty(name,delta){
      const i=cart.findIndex(x=>x.name===name); if(i===-1)return;
      const q=cart[i].qty+delta;
      if(q<=0) cart.splice(i,1); else cart[i].qty=q;
      renderCart();
    }
    function removeItem(name){ cart=cart.filter(x=>x.name!==name); renderCart(); }
    function clearCart(){ cart=[]; renderCart(); }

    function renderCart(){
      const ul=document.getElementById('cart'); ul.innerHTML='';
      let subtotal=0,count=0;
      cart.forEach(item=>{
        const line=item.price*item.qty; subtotal+=line; count+=item.qty;
        const li=document.createElement('li');
        li.className='py-2 flex items-center justify-between gap-2';
        li.innerHTML=`
          <div class="flex-1">
            <div class="font-medium">${item.name}</div>
            <div class="text-xs text-gray-500">${fmt(item.price)} c/u</div>
          </div>
          <div class="flex items-center gap-2">
            <button class="px-2 py-1 border rounded" onclick="changeQty('${item.name.replace(/'/g,"\\'")}',-1)">‚àí</button>
            <span class="w-8 text-center">${item.qty}</span>
            <button class="px-2 py-1 border rounded" onclick="changeQty('${item.name.replace(/'/g,"\\'")}',1)">+</button>
          </div>
          <div class="w-24 text-right font-semibold">${fmt(line)}</div>
          <button class="text-red-600" onclick="removeItem('${item.name.replace(/'/g,"\\'")}')">üóëÔ∏è</button>`;
        ul.appendChild(li);
      });
      document.getElementById('cart-items-count').textContent=`${count} √≠tems`;
      const dPct=Math.min(Math.max(parseFloat(document.getElementById('discount').value||'0'),0),100);
      const dVal=Math.round(subtotal*(dPct/100));
      const total=subtotal-dVal;
      document.getElementById('subtotal').textContent=fmt(subtotal);
      document.getElementById('discount-amount').textContent=fmt(dVal);
      document.getElementById('total').textContent=fmt(total);
      const pay=document.getElementById('pay-method').value;
      const received=parseInt(document.getElementById('cash-received').value||'0',10);
      const change=pay==='Efectivo'?Math.max(received-total,0):0;
      document.getElementById('change').textContent=fmt(change);
      updateProductSelectionUI();
    }

    function checkout(){
      if(!cart.length){ alert('El carrito est√° vac√≠o'); return; }
      const subtotal=cart.reduce((s,it)=>s+it.price*it.qty,0);
      const dPct=Math.min(Math.max(parseFloat(document.getElementById('discount').value||'0'),0),100);
      const dVal=Math.round(subtotal*(dPct/100));
      const total=subtotal-dVal;
      const pay=document.getElementById('pay-method').value;
      const received=parseInt(document.getElementById('cash-received').value||'0',10);
      const change=pay==='Efectivo'?Math.max(received-total,0):0;

      const sale={
        id: nextConsec(), dateISO: new Date().toISOString(), dayKey: todayKey(),
        items: cart.map(i=>({name:i.name,qty:i.qty,price:i.price})),
        subtotal, discountPct:dPct, discountAmount:dVal, total, payMethod: pay, received, change
      };

      // Descontar inventario (no negativo)
      const inv=loadInv();
      sale.items.forEach(it=>{ inv[it.name] = Math.max(0,(inv[it.name]||0) - it.qty); });
      saveInv(inv);

      const hist=loadHist(); hist.push(sale); saveHist(hist);

      document.getElementById('discount').value='';
      document.getElementById('cash-received').value='';
      cart=[]; renderCart(); renderSalesToday();
      renderProducts(document.getElementById('search').value, document.getElementById('filter-category').value);
    }

    /* ===== Ventas del d√≠a ===== */
    function renderSalesToday(){
      const body=document.getElementById('sales-body'); if(!body) return; body.innerHTML='';
      const hist=loadHist().filter(s=>s.dayKey===todayKey());
      let sumT=0;
      hist.forEach(s=>{
        sumT+=s.total;
        const t=new Date(s.dateISO);
        const tr=document.createElement('tr');
        tr.innerHTML=`<td class="p-2">${s.id}</td>
                      <td class="p-2">${t.toLocaleTimeString('es-CO',{hour:'2-digit',minute:'2-digit'})}</td>
                      <td class="p-2">${s.payMethod}</td>
                      <td class="p-2 text-right">${fmt(s.total)}</td>`;
        body.appendChild(tr);
      });
      const el=document.getElementById('sum-total'); if(el) el.textContent=fmt(sumT);
    }
    function exportCSVToday(){
      const rows=[['id','fecha','hora','metodo','subtotal','descuento_pct','descuento_valor','total','recibido','cambio','items']];
      const hist=loadHist().filter(s=>s.dayKey===todayKey());
      hist.forEach(s=>{
        const d=new Date(s.dateISO);
        rows.push([
          s.id, d.toLocaleDateString('es-CO'), d.toLocaleTimeString('es-CO'), s.payMethod,
          s.subtotal, s.discountPct, s.discountAmount, s.total, s.received||0, s.change||0,
          s.items.map(i=>`${i.qty}x ${i.name}`).join(' | ')
        ]);
      });
      const csv=rows.map(r=>r.map(x=>`"${String(x).replaceAll('"','""')}"`).join(',')).join('\n');
      const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob);
      const a=document.createElement('a'); a.href=url; a.download=`ventas_${todayKey()}.csv`; a.click(); URL.revokeObjectURL(url);
    }

    /* ===== CRUD Productos ===== */
    function renderProductsTable(){
      const body=document.getElementById('product-body'); if(!body) return; body.innerHTML='';
      getProducts().forEach((p,idx)=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`
          <td class="p-2">${p.name}</td>
          <td class="p-2 text-right">${fmt(p.price)}</td>
          <td class="p-2">${p.category||''}</td>
          <td class="p-2 text-right">
            <button class="px-2 py-1 border rounded mr-1" onclick="openProductModal(${idx})">Editar</button>
            <button class="px-2 py-1 border rounded text-red-600" onclick="deleteProduct(${idx})">Eliminar</button>
          </td>`;
        body.appendChild(tr);
      });
    }
    function openProductModal(index){
      const products=getProducts(); const editing=index!=null && index>=0;
      const modal=document.getElementById('product-modal');
      const title=document.getElementById('product-modal-title');
      const name=document.getElementById('pm-name');
      const price=document.getElementById('pm-price');
      const cat=document.getElementById('pm-category');
      title.textContent=editing?'Editar producto':'Nuevo producto';
      if(editing){ name.value=products[index].name; price.value=products[index].price; cat.value=products[index].category||''; }
      else{ name.value=''; price.value=''; cat.value=''; }
      modal.dataset.index=editing?String(index):'';
      modal.classList.remove('hidden'); modal.classList.add('flex');
    }
    function closeProductModal(){ const m=document.getElementById('product-modal'); m.classList.add('hidden'); m.classList.remove('flex'); m.dataset.index=''; }
    function saveProductFromModal(){
      const name=document.getElementById('pm-name').value.trim();
      const price=parseInt(document.getElementById('pm-price').value||'0',10);
      const category=document.getElementById('pm-category').value.trim();
      if(!name || price<=0){ alert('Nombre y precio son obligatorios'); return; }
      const products=getProducts();
      const idxStr=document.getElementById('product-modal').dataset.index;
      if(idxStr!==''){ const i=parseInt(idxStr,10); products[i]={name,price,category}; }
      else{ products.push({name,price,category}); }
      saveProducts(products); closeProductModal();
      hydrateCategories(); renderProducts(document.getElementById('search').value, document.getElementById('filter-category').value);
      renderProductsTable(); syncInventoryWithProducts(); renderInventoryTable();
    }
    function deleteProduct(index){
      const products=getProducts(); const p=products[index];
      if(!confirm(`¬øEliminar "${p.name}"?`)) return;
      products.splice(index,1); saveProducts(products);
      hydrateCategories(); renderProducts(document.getElementById('search').value, document.getElementById('filter-category').value);
      renderProductsTable(); syncInventoryWithProducts(); renderInventoryTable();
    }
    function exportProductsCSV(){
      const rows=[['name','price','category']]; getProducts().forEach(p=>rows.push([p.name,p.price,p.category||'']));
      const csv=rows.map(r=>r.map(x=>`"${String(x).replaceAll('"','""')}"`).join(',')).join('\n');
      const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob);
      const a=document.createElement('a'); a.href=url; a.download='productos.csv'; a.click(); URL.revokeObjectURL(url);
    }
    function importProductsCSV(file){
      const reader=new FileReader();
      reader.onload=()=>{
        try{
          const text=String(reader.result||'');
          const lines=text.split(/\r?\n/).filter(Boolean);
          if(!lines.length) return alert('CSV vac√≠o');
          const header=lines.shift().split(',').map(s=>s.replace(/^\"|\"$/g,'').trim().toLowerCase());
          const iName=header.indexOf('name'), iPrice=header.indexOf('price'), iCat=header.indexOf('category');
          if(iName===-1 || iPrice===-1) return alert('El CSV debe incluir columnas name y price');
          const arr=[];
          for(const line of lines){
            const cols=line.match(/\"([^\"]*)\"|[^,]+/g)||[];
            const safe=cols.map(c=>c.replace(/^\"|\"$/g,'').trim());
            const name=safe[iName]||''; const price=parseInt((safe[iPrice]||'0').replace(/\D+/g,''),10); const category=iCat!==-1?safe[iCat]:'';
            if(name && price>0) arr.push({name,price,category});
          }
          if(!arr.length) return alert('No se encontraron productos v√°lidos.');
          saveProducts(arr);
          hydrateCategories(); renderProducts(document.getElementById('search').value, document.getElementById('filter-category').value);
          renderProductsTable(); syncInventoryWithProducts(); renderInventoryTable();
          alert('Productos importados correctamente');
        }catch(e){ alert('Error al importar CSV'); }
      };
      reader.readAsText(file,'utf-8');
    }

    /* ===== Inventario UI & CSV ===== */
    function renderInventoryTable(){
      const body=document.getElementById('inv-body'); if(!body) return; body.innerHTML='';
      const products=getProducts(); const inv=loadInv(); const min=loadInvMin();
      products.forEach(p=>{
        const stock=inv[p.name]||0, minimo=min[p.name]||0;
        const tr=document.createElement('tr');
        tr.innerHTML=`
          <td class="p-2">${p.name}</td>
          <td class="p-2">${p.category||''}</td>
          <td class="p-2 text-right">
            <div class="flex justify-end gap-2">
              <button class="px-2 py-1 border rounded" data-action="dec">‚àí</button>
              <input type="number" class="w-20 border rounded px-2 text-right" value="${stock}" data-kind="stock">
              <button class="px-2 py-1 border rounded" data-action="inc">+</button>
            </div>
          </td>
          <td class="p-2 text-right">
            <input type="number" class="w-20 border rounded px-2 text-right" value="${minimo}" data-kind="min">
          </td>
          <td class="p-2 text-right">
            <button class="px-2 py-1 border rounded" data-action="save">Guardar</button>
            <button class="px-2 py-1 border rounded text-red-600" data-action="zero">Stock=0</button>
          </td>`;
        tr.querySelector('[data-action="inc"]').addEventListener('click',()=>{ const i=tr.querySelector('input[data-kind="stock"]'); i.value=parseInt(i.value||'0',10)+1; });
        tr.querySelector('[data-action="dec"]').addEventListener('click',()=>{ const i=tr.querySelector('input[data-kind="stock"]'); i.value=Math.max(0,parseInt(i.value||'0',10)-1); });
        tr.querySelector('[data-action="save"]').addEventListener('click',()=>{
          const stockVal=Math.max(0,parseInt(tr.querySelector('input[data-kind="stock"]').value||'0',10));
          const minVal=Math.max(0,parseInt(tr.querySelector('input[data-kind="min"]').value||'0',10));
          const inv2=loadInv(), min2=loadInvMin(); inv2[p.name]=stockVal; min2[p.name]=minVal; saveInv(inv2); saveInvMin(min2);
          renderProducts(document.getElementById('search').value, document.getElementById('filter-category').value);
          alert('Guardado ‚úî');
        });
        tr.querySelector('[data-action="zero"]').addEventListener('click',()=>{ const inv2=loadInv(); inv2[p.name]=0; saveInv(inv2); renderInventoryTable(); renderProducts(document.getElementById('search').value, document.getElementById('filter-category').value); });
        body.appendChild(tr);
      });
    }
    function exportInventoryCSV(){
      const inv=loadInv(), min=loadInvMin();
      const rows=[['name','stock','min']]; getProducts().forEach(p=>rows.push([p.name,inv[p.name]||0,min[p.name]||0]));
      const csv=rows.map(r=>r.map(x=>`"${String(x).replaceAll('"','""')}"`).join(',')).join('\n');
      const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob);
      const a=document.createElement('a'); a.href=url; a.download='inventario.csv'; a.click(); URL.revokeObjectURL(url);
    }
    function importInventoryCSV(file){
      const reader=new FileReader();
      reader.onload=()=>{
        try{
          const text=String(reader.result||'');
          const lines=text.split(/\r?\n/).filter(Boolean); if(!lines.length) return alert('CSV vac√≠o');
          const header=lines.shift().split(',').map(s=>s.replace(/^"|"$/g,'').trim().toLowerCase());
          const iName=header.indexOf('name'), iStock=header.indexOf('stock'), iMin=header.indexOf('min');
          if(iName===-1 || iStock===-1) return alert('CSV: columnas requeridas name, stock (min opcional)');
          const inv=loadInv(), min=loadInvMin(); const valid=new Set(getProducts().map(p=>p.name.toLowerCase().trim()));
          lines.forEach(line=>{
            const cols=line.match(/"([^"]*)"|[^,]+/g)||[]; const safe=cols.map(c=>c.replace(/^"|"$/g,'').trim());
            const name=safe[iName]||''; const k=name.toLowerCase().trim(); if(!valid.has(k)) return;
            const stock=parseInt((safe[iStock]||'0').replace(/\D+/g,''),10); const minVal=iMin!==-1?parseInt((safe[iMin]||'0').replace(/\D+/g,''),10):0;
            inv[name]=Math.max(0,isNaN(stock)?0:stock); min[name]=Math.max(0,isNaN(minVal)?0:minVal);
          });
          saveInv(inv); saveInvMin(min); renderInventoryTable(); renderProducts(document.getElementById('search').value, document.getElementById('filter-category').value);
          alert('Inventario importado correctamente ‚úî');
        }catch(e){ alert('Error al importar CSV'); }
      };
      reader.readAsText(file,'utf-8');
    }

    /* ===== Cierre ===== */
    const ventasDeHoy=()=>loadHist().filter(s=>s.dayKey===todayKey());
    const resumenPorMetodo=(ventas)=>Array.from(ventas.reduce((m,v)=>{ const k=v.payMethod||'Otro'; const o=m.get(k)||{count:0,total:0}; o.count++; o.total+=v.total; m.set(k,o); return m; },new Map()),([method,d])=>({method,count:d.count,total:d.total,avg:d.count?Math.round(d.total/d.count):0})).sort((a,b)=>a.method.localeCompare(b.method));
    function renderCierre(){
      const body=document.getElementById('cierre-body'); body.innerHTML='';
      const rows=resumenPorMetodo(ventasDeHoy()); let sumCant=0,sumTotal=0;
      rows.forEach(r=>{ sumCant+=r.count; sumTotal+=r.total;
        const tr=document.createElement('tr');
        tr.innerHTML=`<td class="p-2">${r.method}</td>
                      <td class="p-2 text-right">${r.count}</td>
                      <td class="p-2 text-right">${fmt(r.total)}</td>
                      <td class="p-2 text-right">${fmt(r.avg)}</td>`;
        body.appendChild(tr);
      });
      document.getElementById('cierre-sum-cant').textContent=String(sumCant);
      document.getElementById('cierre-sum-total').textContent=fmt(sumTotal);
      return {sumCant,sumTotal,rows};
    }
    function imprimirTextoPlano(text){
      const w=window.open('','_blank'); w.document.write(`<pre style="font-family: ui-monospace, SFMono-Regular, Menlo, monospace; white-space: pre-wrap;">${text}</pre>`); w.document.close(); w.focus(); w.print();
    }
    function generarTextoCorte(tipo,info){
      const now=new Date();
      const encabezado=[
        '        LA BOMBA 44 ‚Äì '+(tipo==='Z'?'CORTE Z':'CORTE X'),
        '----------------------------------------',
        `Fecha: ${now.toLocaleDateString('es-CO')} ${now.toLocaleTimeString('es-CO')}`,
        `D√≠a: ${todayKey()}`,
        '----------------------------------------'
      ];
      const body=info.rows.map(r=>`${r.method.padEnd(14)}  ${String(r.count).padStart(3)}  ${fmt(r.total).padStart(10)}  (avg ${fmt(r.avg)})`);
      const footer=['----------------------------------------',`TOTAL TICKETS: ${info.sumCant}`,`TOTAL VENDIDO: ${fmt(info.sumTotal)}`,'----------------------------------------',(tipo==='Z'?'Cierre registrado y ventas del d√≠a limpiadas.':'Resumen sin borrar ventas.')];
      return [...encabezado,...body,...footer].join('\n');
    }
    function guardarCierreZ(info){
      const arr=JSON.parse(localStorage.getItem('cierres_historial')||'[]');
      arr.push({dateISO:new Date().toISOString(),dayKey:todayKey(),sumTickets:info.sumCant,sumTotal:info.sumTotal,breakdown:info.rows});
      localStorage.setItem('cierres_historial',JSON.stringify(arr));
    }

    /* ===== Tabs ===== */
    function setTab(tab){
      document.getElementById('view-venta').classList.toggle('hidden', tab!=='venta');
      document.getElementById('view-ventas-dia').classList.toggle('hidden', tab!=='ventas');
      document.getElementById('view-productos').classList.toggle('hidden', tab!=='productos');
      document.getElementById('view-inventario').classList.toggle('hidden', tab!=='inventario');
      document.getElementById('view-cierre').classList.toggle('hidden', tab!=='cierre');

      document.getElementById('tab-venta').className       = tab==='venta'      ? 'tab-btn px-4 py-2 rounded border tab-active' : 'tab-btn px-4 py-2 rounded border bg-white';
      document.getElementById('tab-ventas-dia').className  = tab==='ventas'     ? 'tab-btn px-4 py-2 rounded border tab-active' : 'tab-btn px-4 py-2 rounded border bg-white';
      document.getElementById('tab-productos').className   = tab==='productos'  ? 'tab-btn px-4 py-2 rounded border tab-active' : 'tab-btn px-4 py-2 rounded border bg-white';
      document.getElementById('tab-inventario').className  = tab==='inventario' ? 'tab-btn px-4 py-2 rounded border tab-active' : 'tab-btn px-4 py-2 rounded border bg-white';
      document.getElementById('tab-cierre').className      = tab==='cierre'     ? 'tab-btn px-4 py-2 rounded border tab-active' : 'tab-btn px-4 py-2 rounded border bg-white';

      if (tab==='ventas') renderSalesToday();
      if (tab==='inventario'){ syncInventoryWithProducts(); renderInventoryTable(); }
      if (tab==='cierre') renderCierre();
    }

    /* ===== Listeners ===== */
    document.getElementById('tab-venta').addEventListener('click',()=>setTab('venta'));
    document.getElementById('tab-ventas-dia').addEventListener('click',()=>setTab('ventas'));
    document.getElementById('tab-productos').addEventListener('click',()=>setTab('productos'));
    document.getElementById('tab-inventario').addEventListener('click',()=>setTab('inventario'));
    document.getElementById('tab-cierre').addEventListener('click',()=>setTab('cierre'));

    document.getElementById('search').addEventListener('input', e=>{
      renderProducts(e.target.value, document.getElementById('filter-category').value);
    });
    document.getElementById('filter-category').addEventListener('change', e=>{
      renderProducts(document.getElementById('search').value, e.target.value);
    });

    document.getElementById('btn-clear').addEventListener('click', clearCart);
    document.getElementById('checkout').addEventListener('click', checkout);
    document.getElementById('btn-export').addEventListener('click', exportCSVToday);

    document.getElementById('btn-add-product').addEventListener('click', () => openProductModal(-1));
    document.getElementById('product-close').addEventListener('click', closeProductModal);
    document.getElementById('product-save').addEventListener('click', saveProductFromModal);
    document.getElementById('btn-export-products').addEventListener('click', exportProductsCSV);
    document.getElementById('btn-reset-defaults').addEventListener('click', () => {
      saveProducts(DEFAULT_PRODUCTS.slice());
      hydrateCategories(); renderProducts(document.getElementById('search').value, document.getElementById('filter-category').value);
      renderProductsTable(); syncInventoryWithProducts(); renderInventoryTable();
    });
    document.getElementById('input-import-products').addEventListener('change', (e) => {
      const f = e.target.files && e.target.files[0]; if (f) importProductsCSV(f); e.target.value = '';
    });

    document.getElementById('btn-inv-sync').addEventListener('click', () => {
      syncInventoryWithProducts(); renderInventoryTable(); renderProducts(document.getElementById('search').value, document.getElementById('filter-category').value);
    });
    document.getElementById('btn-inv-export').addEventListener('click', exportInventoryCSV);
    document.getElementById('btn-inv-reset-min').addEventListener('click', () => {
      saveInvMin({}); renderInventoryTable(); alert('M√≠nimos reiniciados a 0');
    });
    document.getElementById('input-inv-import').addEventListener('change', (e) => {
      const f = e.target.files && e.target.files[0]; if (f) importInventoryCSV(f); e.target.value = '';
    });

    document.getElementById('btn-corte-x').addEventListener('click', () => {
      const info = renderCierre(); const texto = generarTextoCorte('X', info); imprimirTextoPlano(texto);
    });
    document.getElementById('btn-corte-z').addEventListener('click', () => {
      const info = renderCierre(); if (!info.sumCant) { alert('No hay ventas hoy.'); return; }
      if (!confirm('¬øConfirmas CORTE Z? Esto registrar√° el cierre y borrar√° TODAS las ventas de hoy.')) return;
      guardarCierreZ(info);
      const all = loadHist(); const rest = all.filter(s => s.dayKey !== todayKey()); saveHist(rest);
      renderSalesToday(); renderCierre(); alert('Corte Z realizado. Ventas del d√≠a limpiadas.');
      renderProducts(document.getElementById('search').value, document.getElementById('filter-category').value);
    });

    /* ===== Init ===== */
    syncInventoryWithProducts();
    hydrateCategories();
    renderProducts();
    renderProductsTable();
    renderSalesToday();
  </script>
</body>
</html>
